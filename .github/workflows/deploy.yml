name: CI/CD Google Cloud Run - Usando Docker Hub

on:
  push:
    branches:
      - master

# Variáveis de ambiente globais
env:
  DOCKER_REPO_PREFIX: ${{ secrets.DOCKER_USERNAME }} # Prefixo para as imagens (seu_usuario/)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # ----------------------------------------------------
      # 1. LOGIN NO DOCKER HUB
      # ----------------------------------------------------
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ----------------------------------------------------
      # 2. AUTENTICAÇÃO NO GOOGLE CLOUD
      # ----------------------------------------------------
      - name: Authenticate Google Cloud (for Deploy Permissions)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ====================================================
      # 3. POSTGRESQL: BUILD
      # ====================================================
      - name: Deploy PostgreSQL (Pre-built Image) to Cloud Run
        run: |
          # Certifique-se de que esta é a URL correta da sua imagem
          IMAGE_URL="postgres:16-alpine" 
          
          # Deploy no Cloud Run com Variáveis de Ambiente e Timeout
          gcloud run deploy postgres-db-demo \
            --image $IMAGE_URL \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --quiet \
            --min-instances 0 \
            --no-allow-unauthenticated \
            --port 5432 \
            --timeout 60s \
            --set-env-vars POSTGRES_USER=${{ secrets.DB_USER }},POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }},POSTGRES_DB=${{ secrets.DB_NAME }}


      # ====================================================
      # 4. FASTAPI: BUILD E PUSH
      # ====================================================
      - name: Build and Push FastAPI
        run: |
          IMAGE_URL=${{ env.DOCKER_REPO_PREFIX }}/backend-api:latest
          docker build -t $IMAGE_URL backend/
          docker push $IMAGE_URL

      - name: Deploy FastAPI to Cloud Run
        run: |
          IMAGE_URL=${{ env.DOCKER_REPO_PREFIX }}/backend-api:latest
          gcloud run deploy fastapi-backend-prod \
            --image $IMAGE_URL \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --quiet \
            --min-instances 0 \
            --allow-unauthenticated

      # ====================================================
      # 5. EXPO: BUILD E PUSH
      # ====================================================
      - name: Build and Push Expo
        run: |
          IMAGE_URL=${{ env.DOCKER_REPO_PREFIX }}/expo-app:latest
          docker build -t $IMAGE_URL lexilive-project/LexiLive/
          docker push $IMAGE_URL

      - name: Deploy Expo App to Cloud Run
        run: |
          IMAGE_URL=${{ env.DOCKER_REPO_PREFIX }}/expo-app:latest
          gcloud run deploy expo-frontend-prod \
            --image $IMAGE_URL \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --quiet \
            --min-instances 0 \
            --allow-unauthenticated